osx_image: xcode7.3

matrix:
  include:
    - os: osx
      env: TEST_FILES=BuildTest,linuxPackagerTest,globTest NODE_VERSION=6 PUBLISH_TO_NPM=true

    - os: osx
      env: TEST_FILES=winPackagerTest,nsisTest,macPackagerTest NODE_VERSION=6

    - os: osx
      env: TEST_FILES=macPackagerTest,CodeSignTest NODE_VERSION=4

language: c

cache:
  directories:
    - node_modules
    - $HOME/.electron

before_install:
  - curl -L https://dl.bintray.com/develar/bin/7za -o /tmp/7za
  - chmod +x /tmp/7za
  - curl -L https://dl.bintray.com/develar/bin/wine.7z -o /tmp/wine.7z
  - brew unlink libpng
  # https://github.com/Homebrew/homebrew-core/issues/2987
  - brew prune
  - rm -rf /usr/local/Cellar/libpng
  - /tmp/7za x -aoa /tmp/wine.7z -o/usr/local/Cellar -y
  - brew link --overwrite fontconfig libpng freetype gd gnutls jasper libgphoto2 libicns libtasn1 libusb libusb-compat little-cms2 nettle sane-backends webp wine git-lfs gnu-tar dpkg graphicsmagick xz
  - git-lfs pull

install:
- nvm install $NODE_VERSION
- nvm use --delete-prefix $NODE_VERSION
- if [[ "$TRAVIS_OS_NAME" == "osx" && "$NODE_VERSION" == "4" ]]; then npm install npm -g ; fi
- npm install
- npm prune

script:
- sudo ntpdate -u time.apple.com
- npm run test

after_success:
- if [[ "$TRAVIS_BRANCH" == "master" && "$TRAVIS_PULL_REQUEST" == "false" && "$AUTO_PUBLISH" != "false" && "$TRAVIS_TAG" == "" && "$PUBLISH_TO_NPM" == "true" ]]; then npm run semantic-release ; fi

branches:
  except:
    - "/^v\\d+\\.\\d+\\.\\d+$/"